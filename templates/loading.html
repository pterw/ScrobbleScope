{% extends 'base.html' %}

{% block title %}Loading | ScrobbleScope{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/loading.css') }}">
{% endblock %}

{% block meta %}
<meta name="description" content="ScrobbleScope - Loading your Last.fm album scrobbles. Please wait...">
{% endblock %}

{% block content %}
    <!-- Bridge script to expose parameters to JS -->
    <script>
    window.SCROBBLE = {
      username: "{{ username }}",
      year: "{{ year }}",
      sort_by: "{{ sort_by }}",
      release_scope: "{{ release_scope }}",
      {% if decade %}
      decade: "{{ decade }}",
      {% endif %}
      {% if release_year %}
      release_year: "{{ release_year }}",
      {% endif %}
      min_plays: "{{ min_plays|default('10') }}",
      min_tracks: "{{ min_tracks|default('3') }}"
    };
    </script>

    <div class="loading-container">
        <div class="col-md-9 text-center mx-auto mb-4" id="logo-wrapper">
            <div aria-label="ScrobbleScope logo visualization" role="img">
                {% include 'inline/scrobble_scope_inline.svg' ignore missing %}
            </div>
        </div>

        <h2>Loading your results...</h2>
        <div class="progress mt-4">
            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" id="progress-bar"></div>
        </div>
        <p id="step-text" class="step-text">Initializing...</p>
        <p id="step-details" class="step-details">This might take a few minutes, especially for active Last.fm users</p>

        <div class="request-info">
            <h4>Your Search Parameters</h4>
            <table class="info-table">
                <tr>
                    <td>Username:</td>
                    <td>{{ username }}</td>
                </tr>
                <tr>
                    <td>Year:</td>
                    <td>{{ year }}</td>
                </tr>
                {% if release_scope %}
                <tr>
                    <td>Release Filter:</td>
                    <td>
                        {% if release_scope == "same" %}
                            Same as Listening Year ({{ year }})
                        {% elif release_scope == "previous" %}
                            Previous Year ({{ year - 1 }})
                        {% elif release_scope == "decade" %}
                            {{ decade }}
                        {% elif release_scope == "custom" %}
                            {{ release_year }}
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
                <tr>
                    <td>Sort By:</td>
                    <td>
                        {% if sort_by == "playtime" %}
                            Listening Time
                        {% else %}
                            Play Count
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td>Album Thresholds:</td>
                    <td>Minimum {{ min_plays|default('10') }} plays, {{ min_tracks|default('3') }} unique tracks per album</td>
                </tr>
            </table>
        </div>

        <div id="error-container" class="d-none">
            <div class="error-message">
                <p id="error-text">An error occurred while processing your request.</p>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/loading.js') }}"></script>
{% endblock %}
